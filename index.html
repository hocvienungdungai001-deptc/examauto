<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VDC Smart Grader</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --bg: #f8f9fa; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
        h2 { text-align: center; color: var(--primary); margin-top: 0; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; }
        
        select, input[type="file"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fff; }
        
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-submit { background: var(--primary); color: white; }
        .btn-submit:active { transform: scale(0.98); }
        .btn-disabled { background: #ccc; cursor: not-allowed; }

        #statusBox { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; display: none; font-weight: 500; }
        .status-loading { background: #e2e6ea; color: #333; }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .result-area { margin-top: 25px; border-top: 2px dashed #ddd; padding-top: 20px; display: none; text-align: center; }
        .score-badge { font-size: 48px; font-weight: bold; color: var(--danger); display: block; margin: 10px 0; }
        .result-img { max-width: 100%; border-radius: 8px; border: 2px solid #333; margin-top: 10px; }
        
        .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #888; }
    </style>
</head>
<body>

<div class="card">
    <h2>üì± VDC CH·∫§M THI</h2>
    
    <div class="form-group">
        <label>üìù Lo·∫°i ƒë·ªÅ thi:</label>
        <select id="examType">
            <option value="hybrid">Hybrid (T√¥ tr·ª±c ti·∫øp tr√™n ƒë·ªÅ)</option>
            <option value="matrix">Matrix (Phi·∫øu tr·∫Øc nghi·ªám)</option>
        </select>
    </div>

    <div class="form-group">
        <label>üì∑ T·∫£i l√™n b√†i l√†m (·∫¢nh/PDF):</label>
        <input type="file" id="fileInput" accept="image/*,application/pdf">
    </div>

    <button onclick="submitExam()" id="btnSubmit" class="btn-submit">B·∫ÆT ƒê·∫¶U CH·∫§M</button>

    <div id="statusBox"></div>

    <div id="resultArea" class="result-area">
        <div>ƒêi·ªÉm s·ªë ƒë·∫°t ƒë∆∞·ª£c:</div>
        <span id="scoreDisplay" class="score-badge">--</span>
        <div style="font-size: 14px; color: #666;">·∫¢nh b√†i ch·∫•m chi ti·∫øt:</div>
        <img id="gradedImage" class="result-img" src="" alt="ƒêang t·∫£i ·∫£nh...">
        <button onclick="resetApp()" style="margin-top: 15px; background: #6c757d; color: white;">Ch·∫•m b√†i ti·∫øp theo</button>
    </div>
</div>

<div class="footer">Powered by VDC Technology & AI Dept</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    // ============================================================
    // ‚ö†Ô∏è KHU V·ª∞C C·∫§U H√åNH (B·∫†N C·∫¶N S·ª¨A 2 CH·ªñ N√ÄY)
    // ============================================================

    // 1. LINK APPS SCRIPT WEB APP 
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwVICVuXKF7XFLosu7GEpF2DQOjhb3NSHOXsGGYx20_lpzwZKs6uEfADO6U142vvdY/exec"; // D√°n link c·ªßa b·∫°n v√†o ƒë√¢y

    // 2. FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBa0kw-SXlgrDSrfT_aHTtuQNiXOKUmfA0",
      authDomain: "vdcexamauto.firebaseapp.com",
      databaseURL: "https://vdcexamauto-default-rtdb.firebaseio.com",
      projectId: "vdcexamauto",
      storageBucket: "vdcexamauto.firebasestorage.app",
      messagingSenderId: "423677058933",
      appId: "1:423677058933:web:3e5612cae31758c6b63d3c",
      measurementId: "G-ZXWCEDQ4T8"
    };
    // ============================================================

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const INSTRUCTOR_ID = "GV_VDC_MN"; 

    function resetApp() {
        document.getElementById('resultArea').style.display = 'none';
        document.getElementById('fileInput').value = '';
        document.getElementById('statusBox').style.display = 'none';
        document.getElementById('btnSubmit').disabled = false;
        document.getElementById('btnSubmit').innerText = "B·∫ÆT ƒê·∫¶U CH·∫§M";
        document.getElementById('btnSubmit').classList.remove('btn-disabled');
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });

    async function submitExam() {
        const fileInput = document.getElementById('fileInput');
        const examType = document.getElementById('examType').value;
        const statusDiv = document.getElementById('statusBox');
        const btn = document.getElementById('btnSubmit');

        if (fileInput.files.length === 0) {
            alert("‚ö†Ô∏è Vui l√≤ng ch·ª•p ho·∫∑c ch·ªçn ·∫£nh/PDF b√†i thi!");
            return;
        }

        const file = fileInput.files[0];
        btn.disabled = true;
        btn.classList.add('btn-disabled');
        btn.innerText = "ƒêang x·ª≠ l√Ω...";
        
        statusDiv.style.display = 'block';
        statusDiv.className = 'status-loading';
        statusDiv.innerText = "‚è≥ ƒêang t·∫£i file l√™n h·ªá th·ªëng...";

        try {
            const base64 = await toBase64(file);
            
// --- ƒêO·∫†N CODE ƒê√É S·ª¨A L·ªñI CORS ---
            const response = await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors", // T·∫°m th·ªùi d√πng no-cors ƒë·ªÉ g·ª≠i ƒë∆∞·ª£c d·ªØ li·ªáu ƒëi
                headers: {
                    "Content-Type": "text/plain;charset=utf-8", // QUAN TR·ªåNG: ƒê·ªïi th√†nh text/plain ƒë·ªÉ tr√°nh Preflight
                },
                body: JSON.stringify({
                    base64: base64,
                    filename: `exam_${Date.now()}_${file.name}`,
                    mimeType: file.type
                })
            });

            // ‚ö†Ô∏è L∆ØU √ù QUAN TR·ªåNG V·ªÄ CORS V√Ä APPS SCRIPT:
            // Khi d√πng "no-cors", ch√∫ng ta KH√îNG TH·ªÇ ƒë·ªçc ƒë∆∞·ª£c k·∫øt qu·∫£ tr·∫£ v·ªÅ (response.json()) ngay l·∫≠p t·ª©c.
            // Tuy nhi√™n, d·ªØ li·ªáu V·∫™N ƒê∆Ø·ª¢C G·ª¨I TH√ÄNH C√îNG l√™n Drive.
            // V√¨ v·∫≠y, ta s·∫Ω kh√¥ng ƒë·ª£i link t·ª´ Apps Script n·ªØa m√† s·∫Ω g·ª≠i y√™u c·∫ßu l√™n Firebase lu√¥n.
            // Python s·∫Ω t·ª± l·∫•y link ·∫£nh t·ª´ Drive sau.

            console.log("ƒê√£ g·ª≠i file l√™n Drive (Ch·∫ø ƒë·ªô No-Cors)");
            
            // GI·∫¢ L·∫¨P LINK DRIVE (V√¨ Python s·∫Ω t·ª± t√¨m file m·ªõi nh·∫•t trong th∆∞ m·ª•c, ta kh√¥ng c·∫ßn link ch√≠nh x√°c ngay l√∫c n√†y)
            // Ho·∫∑c ch√∫ng ta ƒë·ª£i Python qu√©t th∆∞ m·ª•c.
            
            // --- S·ª¨A LOGIC G·ª¨I FIREBASE ---
            statusDiv.innerText = "ü§ñ ƒêang g·ª≠i y√™u c·∫ßu ch·∫•m...";
            
            const newReqRef = db.ref(`grading_queue/${INSTRUCTOR_ID}`).push();
            
            await newReqRef.set({
                status: 'pending',
                type: examType,
                // Ta g·ª≠i t√≠n hi·ªáu ƒë·ªÉ Python bi·∫øt c√≥ file m·ªõi, Python s·∫Ω t·ª± qu√©t folder Drive
                // L∆∞u √Ω: Code Python c·∫ßn ƒë∆∞·ª£c thi·∫øt l·∫≠p ƒë·ªÉ t·ª± qu√©t file m·ªõi nh·∫•t n·∫øu kh√¥ng nh·∫≠n ƒë∆∞·ª£c link
                timestamp: Date.now()
            });
            
            const result = await response.json();
            
            if (result.status !== "success") {
                throw new Error("L·ªói Upload: " + (result.message || "Kh√¥ng r√µ"));
            }
            
            const driveLink = result.fileUrl;
            console.log("Upload th√†nh c√¥ng:", driveLink);

            statusDiv.innerText = "ü§ñ ƒêang g·ª≠i cho AI ch·∫•m ƒëi·ªÉm...";
            
            const newReqRef = db.ref(`grading_queue/${INSTRUCTOR_ID}`).push();
            
            await newReqRef.set({
                status: 'pending',
                type: examType,
                image_url: driveLink,
                file_type: file.type, // Ghi nh·∫≠n lo·∫°i file
                timestamp: Date.now()
            });

            statusDiv.innerText = "‚ö° ƒêang ƒë·ª£i k·∫øt qu·∫£ t·ª´ m√°y ch·ªß...";
            
            newReqRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.status === 'completed') {
                    statusDiv.className = 'status-success';
                    statusDiv.innerText = "‚úÖ ƒê√£ ch·∫•m xong!";
                    
                    document.getElementById('resultArea').style.display = 'block';
                    document.getElementById('scoreDisplay').innerText = data.score + "/10";
                    document.getElementById('gradedImage').src = data.result_image_url;
                    
                    newReqRef.off(); 
                }
            });

        } catch (error) {
            console.error(error);
            statusDiv.className = 'status-error';
            statusDiv.innerText = "‚ùå L·ªói: " + error.message;
            btn.disabled = false;
            btn.classList.remove('btn-disabled');
            btn.innerText = "TH·ª¨ L·∫†I";
        }
    }
</script>

</body>
</html>
