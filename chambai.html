<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VDC Smart Grader</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --bg: #f8f9fa; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
        h2 { text-align: center; color: var(--primary); margin-top: 0; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; }
        
        select, input[type="file"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fff; }
        
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-submit { background: var(--primary); color: white; }
        .btn-submit:active { transform: scale(0.98); }
        .btn-disabled { background: #ccc; cursor: not-allowed; }

        #statusBox { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; display: none; font-weight: 500; }
        .status-loading { background: #e2e6ea; color: #333; }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .result-area { margin-top: 25px; border-top: 2px dashed #ddd; padding-top: 20px; display: none; text-align: center; }
        .score-badge { font-size: 48px; font-weight: bold; color: var(--danger); display: block; margin: 10px 0; }
        .result-img { max-width: 100%; border-radius: 8px; border: 2px solid #333; margin-top: 10px; }
        
        .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #888; }
    </style>
</head>
<body>

<div class="card">
    <h2>üì± VDC CH·∫§M THI</h2>
    
    <div class="form-group">
        <label>üìù Lo·∫°i ƒë·ªÅ thi:</label>
        <select id="examType">
            <option value="hybrid">Hybrid (T√¥ tr·ª±c ti·∫øp tr√™n ƒë·ªÅ)</option>
            <option value="matrix">Matrix (Phi·∫øu tr·∫Øc nghi·ªám)</option>
        </select>
    </div>

    <div class="form-group">
        <label>üì∑ Ch·ª•p ·∫£nh b√†i l√†m:</label>
        <input type="file" id="fileInput" accept="image/*" capture="environment">
    </div>

    <button onclick="submitExam()" id="btnSubmit" class="btn-submit">B·∫ÆT ƒê·∫¶U CH·∫§M</button>

    <div id="statusBox"></div>

    <div id="resultArea" class="result-area">
        <div>ƒêi·ªÉm s·ªë ƒë·∫°t ƒë∆∞·ª£c:</div>
        <span id="scoreDisplay" class="score-badge">--</span>
        <div style="font-size: 14px; color: #666;">·∫¢nh b√†i ch·∫•m chi ti·∫øt:</div>
        <img id="gradedImage" class="result-img" src="" alt="ƒêang t·∫£i ·∫£nh...">
        <button onclick="resetApp()" style="margin-top: 15px; background: #6c757d; color: white;">Ch·∫•m b√†i ti·∫øp theo</button>
    </div>
</div>

<div class="footer">Powered by VDC Technology & AI Dept</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    // ============================================================
    // ‚ö†Ô∏è KHU V·ª∞C C·∫§U H√åNH (B·∫†N C·∫¶N S·ª¨A 2 CH·ªñ N√ÄY)
    // ============================================================

    // 1. LINK APPS SCRIPT WEB APP (L·∫•y t·ª´ b∆∞·ªõc Deploy b√™n Apps Script)
    const APPS_SCRIPT_URL = "D√ÅN_LINK_APPS_SCRIPT_CUA_BAN_VAO_DAY"; 

    // 2. FIREBASE CONFIG (L·∫•y t·ª´ Firebase Console > Project Settings)
    // V√†o https://console.firebase.google.com/ > Ch·ªçn d·ª± √°n m·ªõi > B·∫•m bi·ªÉu t∆∞·ª£ng </> (Web) ƒë·ªÉ l·∫•y code n√†y
    const firebaseConfig = {
        apiKey: "...",
        authDomain: "...",
        databaseURL: "...",
        projectId: "...",
        storageBucket: "...",
        messagingSenderId: "...",
        appId: "..."
    };
    // ============================================================

    // Kh·ªüi t·∫°o Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    
    // T·∫°o ID phi√™n l√†m vi·ªác ng·∫´u nhi√™n (ho·∫∑c Hardcode ID gi·∫£ng vi√™n n·∫øu mu·ªën)
    const INSTRUCTOR_ID = "GV_VDC_MN"; 

    // H√†m reset ƒë·ªÉ ch·∫•m b√†i m·ªõi
    function resetApp() {
        document.getElementById('resultArea').style.display = 'none';
        document.getElementById('fileInput').value = '';
        document.getElementById('statusBox').style.display = 'none';
        document.getElementById('btnSubmit').disabled = false;
        document.getElementById('btnSubmit').innerText = "B·∫ÆT ƒê·∫¶U CH·∫§M";
        document.getElementById('btnSubmit').classList.remove('btn-disabled');
    }

    // H√†m chuy·ªÉn file sang Base64
    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });

    // H√ÄM CH√çNH: G·ª¨I B√ÄI
    async function submitExam() {
        const fileInput = document.getElementById('fileInput');
        const examType = document.getElementById('examType').value;
        const statusDiv = document.getElementById('statusBox');
        const btn = document.getElementById('btnSubmit');

        // Ki·ªÉm tra ƒë·∫ßu v√†o
        if (fileInput.files.length === 0) {
            alert("‚ö†Ô∏è Vui l√≤ng ch·ª•p ho·∫∑c ch·ªçn ·∫£nh b√†i thi!");
            return;
        }

        // Kh√≥a giao di·ªán
        const file = fileInput.files[0];
        btn.disabled = true;
        btn.classList.add('btn-disabled');
        btn.innerText = "ƒêang x·ª≠ l√Ω...";
        
        statusDiv.style.display = 'block';
        statusDiv.className = 'status-loading';
        statusDiv.innerText = "‚è≥ ƒêang t·∫£i ·∫£nh l√™n h·ªá th·ªëng...";

        try {
            // B∆Ø·ªöC 1: UPLOAD ·∫¢NH L√äN GOOGLE DRIVE (Qua Apps Script)
            // -----------------------------------------------------
            const base64 = await toBase64(file);
            
            // S·ª≠ d·ª•ng fetch v·ªõi mode 'no-cors' ƒë·ªÉ tr√°nh l·ªói ch·∫∑n, 
            // ho·∫∑c x·ª≠ l√Ω redirect n·∫øu Apps Script tr·∫£ v·ªÅ JSONP.
            // ·ªû ƒë√¢y ta d√πng POST chu·∫©n, y√™u c·∫ßu Apps Script ph·∫£i deploy 'Anyone'.
            
            const response = await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    base64: base64,
                    filename: `exam_${Date.now()}.jpg`,
                    mimeType: file.type
                })
            });
            
            const result = await response.json();
            
            if (result.status !== "success") {
                throw new Error("L·ªói Upload: " + (result.message || "Kh√¥ng r√µ"));
            }
            
            const driveLink = result.fileUrl; // Link ·∫£nh g·ªëc tr√™n Drive
            console.log("Upload th√†nh c√¥ng:", driveLink);

            // B∆Ø·ªöC 2: G·ª¨I Y√äU C·∫¶U CH·∫§M (L√™n Firebase)
            // -----------------------------------------------------
            statusDiv.innerText = "ü§ñ ƒêang g·ª≠i cho AI ch·∫•m ƒëi·ªÉm...";
            
            // T·∫°o m·ªôt key m·ªõi trong h√†ng ƒë·ª£i
            const newReqRef = db.ref(`grading_queue/${INSTRUCTOR_ID}`).push();
            
            await newReqRef.set({
                status: 'pending',
                type: examType,
                image_url: driveLink,
                timestamp: Date.now()
            });

            // B∆Ø·ªöC 3: L·∫ÆNG NGHE K·∫æT QU·∫¢ (Realtime)
            // -----------------------------------------------------
            statusDiv.innerText = "‚ö° ƒêang ƒë·ª£i k·∫øt qu·∫£ t·ª´ m√°y ch·ªß...";
            
            // L·∫Øng nghe s·ª± thay ƒë·ªïi c·ªßa ch√≠nh request v·ª´a g·ª≠i
            newReqRef.on('value', (snapshot) => {
                const data = snapshot.val();
                
                // N·∫øu tr·∫°ng th√°i ƒë·ªïi th√†nh 'completed' -> ƒê√£ c√≥ ƒëi·ªÉm
                if (data && data.status === 'completed') {
                    // Hi·ªÉn th·ªã k·∫øt qu·∫£
                    statusDiv.className = 'status-success';
                    statusDiv.innerText = "‚úÖ ƒê√£ ch·∫•m xong!";
                    
                    document.getElementById('resultArea').style.display = 'block';
                    document.getElementById('scoreDisplay').innerText = data.score + "/10";
                    
                    // Hi·ªÉn th·ªã ·∫£nh ƒë√£ ch·∫•m (Link t·ª´ Drive do Python tr·∫£ v·ªÅ)
                    // L∆∞u √Ω: Link n√†y ph·∫£i l√† webContentLink ho·∫∑c direct link
                    document.getElementById('gradedImage').src = data.result_image_url;
                    
                    // Ng·∫Øt l·∫Øng nghe ƒë·ªÉ ti·∫øt ki·ªám t√†i nguy√™n
                    newReqRef.off(); 
                }
            });

        } catch (error) {
            console.error(error);
            statusDiv.className = 'status-error';
            statusDiv.innerText = "‚ùå L·ªói: " + error.message;
            btn.disabled = false;
            btn.classList.remove('btn-disabled');
            btn.innerText = "TH·ª¨ L·∫†I";
        }
    }
</script>

</body>
</html>
